from PIL import Image
from IPython.display import display
import ipywidgets as widgets
import hashlib

def encode_enc(image, data, key):
    key_bin = format(int(hashlib.sha256(key.encode()).hexdigest(), 16), '0256b')
    datalist = [format(ord(i), '08b') for i in data]
    imdata = iter(image.getdata())
    
    for i in range(len(datalist)):
        pixels = [value for value in next(imdata)[:3] + next(imdata)[:3] + next(imdata)[:3]]
        
        for j in range(8):
            bit = int(datalist[i][j]) ^ int(key_bin[j % len(key_bin)])
            if bit == 0 and pixels[j] % 2 != 0:
                pixels[j] -= 1
            elif bit == 1 and pixels[j] % 2 == 0:
                if pixels[j] != 0:
                    pixels[j] -= 1
                else:
                    pixels[j] += 1

        if i == len(datalist) - 1:
            if pixels[-1] % 2 == 0:
                if pixels[-1] != 0:
                    pixels[-1] -= 1
                else:
                    pixels[-1] += 1
        else:
            if pixels[-1] % 2 != 0:
                pixels[-1] -= 1

        pixels = tuple(pixels)
        yield pixels[:3]
        yield pixels[3:6]
        yield pixels[6:9]

def encode(img, data, new_img_name, key):
    image = Image.open(img, 'r')
    if len(data) == 0:
        raise ValueError('Data is empty')

    newimg = image.copy()
    w = newimg.size[0]
    (x, y) = (0, 0)
    
    for pixel in encode_enc(newimg, data, key):
        newimg.putpixel((x, y), pixel)
        if x == w - 1:
            x = 0
            y += 1
        else:
            x += 1

    newimg.save(new_img_name, 'JPEG' if new_img_name.lower().endswith('.jpg') else str(new_img_name.split(".")[1].upper()))
    display(newimg)

def decode(img, key):
    image = Image.open(img, 'r')
    key_bin = format(int(hashlib.sha256(key.encode()).hexdigest(), 16), '0256b')

    data = ''
    imgdata = iter(image.getdata())

    while True:
        pixels = [value for value in next(imgdata)[:3] +
                  next(imgdata)[:3] +
                  next(imgdata)[:3]]

        binstr = ''
        for i in pixels[:8]:
            bit = int(i % 2) ^ int(key_bin[i % len(key_bin)])
            binstr += str(bit)

        data += chr(int(binstr, 2))
        if pixels[-1] % 2 != 0:
            return data

def main():
    encode_button = widgets.Button(description="Encode")
    decode_button = widgets.Button(description="Decode")
    
    img_input = widgets.Text(placeholder="Enter image name (with extension)")
    data_input = widgets.Text(placeholder="Enter data to be encoded")
    new_img_name_input = widgets.Text(placeholder="Enter the name of new image (with extension)")
    key_input = widgets.Text(placeholder="Enter the key (password)")
    output = widgets.Output()

    def on_encode_button_clicked(b):
        with output:
            output.clear_output()
            encode(img_input.value, data_input.value, new_img_name_input.value, key_input.value)
            print(f"Image saved as {new_img_name_input.value}")

    def on_decode_button_clicked(b):
        with output:
            output.clear_output()
            decoded_data = decode(img_input.value, key_input.value)
            print(f"Decoded Data: {decoded_data}")

    encode_button.on_click(on_encode_button_clicked)
    decode_button.on_click(on_decode_button_clicked)
    
    display(widgets.VBox([widgets.Label("Encode Image"),
                          img_input, data_input, new_img_name_input, key_input, encode_button,
                          widgets.Label("Decode Image"),
                          img_input, key_input, decode_button,
                          output]))

if __name__ == '__main__':
    main()
